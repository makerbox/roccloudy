<div class="popup">
  <% if user_signed_in? %>
	  <% if (current_user.account && current_user.account.approved == 'approved' && current_user.account.seller_level) || (((current_user.has_role? :admin) || (current_user.has_role? :rep)) && (!current_user.mimic.nil?)) %>
	  <!-- if the user has an approved account with a seller level set, then show them their correct price -->
		<% if ((current_user.has_role? :admin) || (current_user.has_role? :rep)) && (!current_user.mimic.nil?) %>
                    <% level = current_user.mimic.account.seller_level.to_i %>
                    <% thisperson = current_user.mimic.account.user %>
                  <% else %>
                    <% level = current_user.account.seller_level.to_i %>
                    <% thisperson = current_user %>
                  <% end %> 

                  <% case level %>
                    <% when 1 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price1, @product.group, @product.code, @product.pricecat, 1) %>
                    <% when 2 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price2, @product.group, @product.code, @product.pricecat, 1) %>
                    <% when 3 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price3, @product.group, @product.code, @product.pricecat, 1) %>
                    <% when 4 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price4, @product.group, @product.code, @product.pricecat, 1) %>
                    <% when 5 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price5, @product.group, @product.code, @product.pricecat, 1) %>
                    <% when 6 %>
		  		<% prodprice = @product.rrp %>
		  <% end %>
		  $<span id="price-display"><%= number_with_precision(prodprice, precision: 2) %></span>
	  <% end %>

	  <% if user_signed_in? %>
		  <% if current_user.account || (((current_user.has_role? :admin) || (current_user.has_role? :rep)) && (!current_user.mimic.nil?)) %>
			  <% if current_user.account.approved == 'approved' || (((current_user.has_role? :admin) || (current_user.has_role? :rep)) && (!current_user.mimic.nil?)) %>
				  	<%= simple_form_for(@quantity) do |f| %>
				  		<%= f.input :qty, input_html: {value: f.object.qty || '1'} %>
				  		<% if @order %>
				  			<%= f.hidden_field :order_id, value: @order.id %>
				  			<%= f.hidden_field :thisgroup, value: @product.group %>
				  		<% end %>
				  		<%= f.hidden_field :product_id, value: @product.id %>
				  		<%= f.submit "ADD TO CART", class: 'btn btn-success' %>
				  	<% end %>
			  <% end %>
		  <% end %>
	  <% end %>
  <% end %>

<script>

$('.form-control').change(function() {
  var route = <%= @product.id %>+"/calc_qty_disc";
   $.ajax({
      url: route ,
      dataType: "json",
      type: "GET",
      data: { qty: $("#quantity_qty").val(), 
      price: '<%= prodprice %>',
      pricecat: '<%= @product.pricecat %>',
      code: '<%= @product.code %>',
      group: '<%= @product.group %>' },
      success: function(data) {
        $("#price-display").html(data.result.toFixed(2)); 
        console.log(data.result);
        console.log('<%= @product.group %>.<%= @product.code %>'); }
      });
});

</script>
